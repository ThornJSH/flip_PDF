<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
<title>PDF ÌîåÎ¶ΩÎ∂Å</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap');

*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;}
body{
    font-family:'Sora',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
    background:#000;
    color:#1a1a1a;
}
.app{display:flex;width:100%;height:100%;}

/* Î°úÎî© ÌôîÎ©¥ */
.loading-screen{
    display:flex;flex-direction:column;justify-content:center;align-items:center;
    width:100%;height:100%;
    background:linear-gradient(135deg,#1a1a1a 0%,#2a2a2a 100%);
    color:#fff;
}
.loading-icon{font-size:5em;margin-bottom:30px;animation:bounce 2s infinite;}
@keyframes bounce{0%,100%{transform:translateY(0);}50%{transform:translateY(-20px);}}
.loading-text{font-size:1.3em;color:#aaa;font-weight:500;margin-bottom:20px;}
.progress-container{width:300px;max-width:80%;background:#333;border-radius:12px;overflow:hidden;height:12px;margin-top:10px;}
.progress-bar{height:100%;width:0%;background:linear-gradient(90deg,#7c3aed,#6d28d9);transition:width 0.3s ease;}
.progress-percent{margin-top:10px;font-size:1em;color:#aaa;font-weight:500;}
.loading-credit{font-size:0.9em;color:#666;margin-top:40px;text-align:center;line-height:1.8;}
.loading-credit-link{color:#7c3aed;text-decoration:none;font-weight:600;}
.loading-credit-link:hover{text-decoration:underline;color:#a855f7;}

/* Î∑∞Ïñ¥ */
.viewer-screen{display:none;width:100%;height:100%;background:#000;position:relative;overflow:hidden;}
.viewer-screen.show{display:flex;}
.canvas{width:100%;height:100%;display:flex;justify-content:center;align-items:center;overflow:hidden;background:#000;position:relative;}
#flipbook{background:white;box-shadow:0 0 40px rgba(0,0,0,0.4);overflow:hidden;max-width:100%;max-height:100%;}
.page{background:white;display:flex!important;justify-content:center;align-items:center;overflow:hidden;}
.page img{max-width:100%;max-height:100%;object-fit:contain;pointer-events:none;}
.touch-zone{position:absolute;height:100%;top:0;cursor:pointer;z-index:5;}
.touch-zone-left{left:0;width:30%;}
.touch-zone-right{right:0;width:30%;}
.page-info{
    position:absolute;bottom:30px;left:50%;transform:translateX(-50%);
    background:rgba(255,255,255,0.15);color:white;padding:12px 24px;border-radius:24px;
    font-size:0.95em;font-weight:600;backdrop-filter:blur(10px);z-index:10;pointer-events:none;
}
.floating-nav{position:fixed;top:24px;display:flex;gap:16px;z-index:20;}
.floating-nav.left{left:24px;}
.floating-nav.right{right:24px;}
.nav-btn{
    width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#7c3aed 0%,#6d28d9 100%);
    color:white;border:none;cursor:pointer;font-size:1.3em;transition:all 0.3s;
    box-shadow:0 8px 24px rgba(124,58,237,0.3);display:flex;align-items:center;justify-content:center;
}
.nav-btn:hover{transform:translateY(-3px);box-shadow:0 12px 32px rgba(124,58,237,0.4);}
.nav-btn:active{transform:translateY(-1px);}
.nav-btn:disabled{opacity:0.4;cursor:not-allowed;}
.settings-btn{
    position:fixed;bottom:30px;right:30px;width:56px;height:56px;border-radius:50%;
    background:linear-gradient(135deg,#7c3aed 0%,#6d28d9 100%);color:white;border:none;
    cursor:pointer;font-size:1.5em;transition:all 0.3s;box-shadow:0 8px 24px rgba(124,58,237,0.3);z-index:20;
}
.settings-btn:hover{transform:scale(1.1);}
@media(max-width:768px){
    .nav-btn{width:44px;height:44px;font-size:1.1em;}
    .settings-btn{width:50px;height:50px;font-size:1.2em;}
}
</style>
</head>
<body>
<div class="app">
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-icon">üìÑ</div>
        <div class="loading-text">PDF Î°úÎî© Ï§ë...</div>
        <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
        <div class="progress-percent" id="progressPercent">0%</div>
        <div class="loading-credit">
            <div>PDF Flipbook powered by <a href="https://welfareact.net" target="_blank" class="loading-credit-link">welfareact.net</a></div>
        </div>
    </div>

    <div class="viewer-screen" id="viewerScreen">
        <div class="floating-nav left"><button class="nav-btn" id="firstBtn" title="Ï≤òÏùåÏúºÎ°ú">‚èÆ</button></div>
        <div class="canvas" id="canvas"><div id="flipbook"></div></div>
        <div class="floating-nav right"><button class="nav-btn" id="lastBtn" title="ÎÅùÏúºÎ°ú">‚è≠</button></div>
        <div class="touch-zone touch-zone-left" id="touchZoneLeft"></div>
        <div class="touch-zone touch-zone-right" id="touchZoneRight"></div>
        <div class="page-info" id="pageInfo">0 / 0</div>
        <button class="settings-btn" onclick="goToSettings()">‚öôÔ∏è</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
let pdfDoc=null,isMobile=false,pdfOrientation='portrait',flipbookReady=false;
const progressBar=document.getElementById('progressBar');
const progressPercent=document.getElementById('progressPercent');

function detectDevice(){
  isMobile=/android|webos|iphone|ipad|ipod|blackberry|mobile|opera mini/i.test(navigator.userAgent.toLowerCase());
}

function showLoading(){document.getElementById('loadingScreen').style.display='flex';}
function showViewer(){document.getElementById('loadingScreen').style.display='none';document.getElementById('viewerScreen').classList.add('show');}

async function loadPDFFromStorage(){
  const url=localStorage.getItem('pdfUrl');
  if(!url){window.location.href='setting.html';return;}
  showLoading();
  try{
    const res=await fetch(url);
    if(!res.ok)throw new Error('PDF ÌååÏùºÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§');
    const ab=await res.arrayBuffer();
    pdfDoc=await pdfjsLib.getDocument({data:ab}).promise;
    await analyzePDF();
    await renderProgressive();
  }catch(err){
    alert('PDF Î°úÎìú Ïã§Ìå®: '+err.message);
    window.location.href='setting.html';
  }
}

async function analyzePDF(){
  let landscapeCount=0;
  for(let i=1;i<=Math.min(3,pdfDoc.numPages);i++){
    const p=await pdfDoc.getPage(i);
    const vp=p.getViewport({scale:1});
    if(vp.width>vp.height)landscapeCount++;
  }
  pdfOrientation=landscapeCount>=2?'landscape':'portrait';
}

async function renderProgressive(){
  const flipbook=document.getElementById('flipbook');
  flipbook.innerHTML='';
  const total=pdfDoc.numPages;
  for(let i=1;i<=total;i++){
    const page=await pdfDoc.getPage(i);
    const vp=page.getViewport({scale:2}); // Í≥†ÌôîÏßà Ïú†ÏßÄ
    const c=document.createElement('canvas');
    const ctx=c.getContext('2d');
    c.width=vp.width;c.height=vp.height;
    await page.render({canvasContext:ctx,viewport:vp}).promise;
    const blob=await new Promise(res=>c.toBlob(res,'image/png'));
    const url=URL.createObjectURL(blob);
    const div=document.createElement('div');
    div.className='page';
    div.innerHTML=`<img src="${url}" alt="page ${i}">`;
    flipbook.appendChild(div);
    updateProgress(i,total);
    if(i===1) initFlipbook();
  }
  showViewer();
  updatePage();
}

function updateProgress(cur,total){
  const pct=Math.round((cur/total)*100);
  progressBar.style.width=pct+'%';
  progressPercent.textContent=pct+'%';
}

function getOptimalSize(){
  let w,h,disp;
  if(isMobile){w=window.innerWidth;h=window.innerHeight;disp='single';}
  else{
    disp=pdfOrientation==='landscape'?'single':'double';
    if(pdfOrientation==='landscape'){w=Math.min(window.innerWidth*0.98,1500);h=Math.min(window.innerHeight*0.98,800);}
    else{w=Math.min(window.innerWidth*0.95,1100);h=Math.min(window.innerHeight*0.98,900);}
  }
  return{width:w,height:h,display:disp};
}

function initFlipbook(){
  if($('#flipbook').turn('is'))return;
  const {width,height,display}=getOptimalSize();
  $('#flipbook').turn({
    width,height,display,autoCenter:true,duration:isMobile?500:1000,elevation:30,gradients:true,
    when:{turned:updatePage}
  });
  flipbookReady=true;
}

function updatePage(){
  if(!$('#flipbook').turn('is'))return;
  const c=$('#flipbook').turn('page');
  const t=$('#flipbook').turn('pages');
  document.getElementById('pageInfo').textContent=`${c} / ${t}`;
  document.getElementById('firstBtn').disabled=c===1;
  document.getElementById('lastBtn').disabled=c===t;
}

document.getElementById('firstBtn').onclick=()=>$('#flipbook').turn('page',1);
document.getElementById('lastBtn').onclick=()=>$('#flipbook').turn('page',$('#flipbook').turn('pages'));
document.getElementById('touchZoneLeft').onclick=()=>$('#flipbook').turn('previous');
document.getElementById('touchZoneRight').onclick=()=>$('#flipbook').turn('next');

function goToSettings(){window.location.href='setting.html';}
window.addEventListener('resize',()=>{if(flipbookReady){const {width,height}=getOptimalSize();$('#flipbook').turn('size',width,height);}});
document.addEventListener('keydown',e=>{
  if(!flipbookReady)return;
  if(e.key==='ArrowLeft')$('#flipbook').turn('previous');
  if(e.key==='ArrowRight')$('#flipbook').turn('next');
  if(e.key==='Home')$('#flipbook').turn('page',1);
  if(e.key==='End')$('#flipbook').turn('page',$('#flipbook').turn('pages'));
});

window.addEventListener('DOMContentLoaded',detectDevice);
window.addEventListener('load',()=>setTimeout(loadPDFFromStorage,500));
</script>
</body>
</html>
