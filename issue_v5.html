<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>PDF í”Œë¦½ë¶ (v7 ìµœì¢… ìˆ˜ì •ì•ˆ)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap');
        
        :root {
            --brand-color: #7c3aed;
            --brand-color-dark: #6d28d9;
            --brand-color-light: #a855f7;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        body { font-family: 'Sora', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #000; color: #1a1a1a; -webkit-tap-highlight-color: transparent; }
        .app { display: flex; width: 100%; height: 100%; }

        /* ë¡œë”© í™”ë©´ */
        .loading-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100%; background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); transition: opacity 0.5s ease; position: fixed; z-index: 100; }
        .loading-content { text-align: center; max-width: 400px; width: 90%; }
        .loading-icon { font-size: 5em; margin-bottom: 30px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        .loading-text { font-size: 1.3em; color: #888; font-weight: 500; margin-bottom: 10px; }
        .loading::after { content: '...'; animation: dots 1.5s steps(4) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }
        .progress-container { margin: 30px 0; display: flex; flex-direction: column; gap: 16px; }
        .progress-bar { width: 100%; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3); }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--brand-color) 0%, var(--brand-color-light) 100%); border-radius: 4px; width: 0%; transition: width 0.3s ease; box-shadow: 0 0 16px rgba(124, 58, 237, 0.6); }
        .progress-text { text-align: center; color: #aaa; font-size: 0.95em; font-weight: 600; letter-spacing: 0.5px; }
        .progress-status { text-align: center; color: #888; font-size: 0.85em; margin-top: 8px; min-height: 20px; }
        .loading-credit { font-size: .9em; color: #666; margin-top: 40px; line-height: 1.8; }
        .loading-credit-title { font-size: .95em; color: #888; font-weight: 600; margin-bottom: 8px; }
        .loading-credit-text { color: #666; font-size: .85em; }
        .loading-credit-link { color: var(--brand-color); text-decoration: none; font-weight: 600; transition: all .3s; }
        .loading-credit-link:hover { color: var(--brand-color-light); text-decoration: underline; }

        /* ë·°ì–´ í™”ë©´ */
        .viewer-screen { display: none; flex-direction: column; width: 100%; height: 100%; background: #000; position: relative; overflow: hidden; }
        .viewer-screen.show { display: flex; }
        .top-progress-container { width: 100%; height: 6px; background: rgba(255, 255, 255, 0.08); position: relative; cursor: pointer; user-select: none; flex-shrink: 0; }
        .top-progress-bar { height: 100%; background: linear-gradient(90deg, var(--brand-color) 0%, var(--brand-color-light) 100%); width: 0%; display: flex; align-items: center; justify-content: flex-end; }
        .top-progress-handle { width: 14px; height: 14px; background: white; border-radius: 50%; transform: translateX(50%); cursor: grab; box-shadow: 0 2px 8px rgba(124, 58, 237, 0.5); flex-shrink: 0; }
        .canvas { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; background: #000; position: relative; flex: 1; }
        #flipbook { background: white; box-shadow: 0 0 40px rgba(0, 0, 0, 0.4); overflow: hidden; }
        .page { background: white; display: flex !important; justify-content: center; align-items: center; overflow: hidden; }
        .page img { max-width: 100%; max-height: 100%; object-fit: contain; pointer-events: none; }
        
        /* í„°ì¹˜ ì˜ì—­: z-indexë¥¼ ë†’ì—¬ ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— ìˆë„ë¡ ë³´ì¥ */
        .touch-zone { position: absolute; height: 100%; top: 0; cursor: pointer; z-index: 10; }
        .touch-zone-left { left: 0; width: 30%; }
        .touch-zone-right { right: 0; width: 30%; }

        .page-info { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.15); color: white; padding: 12px 24px; border-radius: 24px; font-size: .95em; font-weight: 600; backdrop-filter: blur(10px); z-index: 15; pointer-events: none; }

        /* ë°ìŠ¤í¬í†± í”Œë¡œíŒ… ë©”ë‰´ */
        .floating-nav { position: fixed; top: 24px; display: flex; gap: 16px; z-index: 20; }
        .floating-nav.left { left: 24px; }
        .floating-nav.right { right: 24px; }
        .nav-btn { width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, var(--brand-color) 0%, var(--brand-color-dark) 100%); color: white; border: none; cursor: pointer; font-size: 1.3em; transition: all .3s; box-shadow: 0 8px 24px rgba(124, 58, 237, 0.3); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); user-select: none; }
        .nav-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 32px rgba(124, 58, 237, 0.4); }
        .nav-btn:active { transform: translateY(-1px); }
        .nav-btn:disabled { opacity: .4; cursor: not-allowed; box-shadow: 0 4px 12px rgba(124, 58, 237, 0.2); transform: none; }

        /* ëª¨ë°”ì¼ í”Œë¡œíŒ… ë©”ë‰´ */
        .mobile-floating-nav { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; gap: 20px; z-index: 25; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .mobile-floating-nav.show { opacity: 1; pointer-events: auto; }
        .mobile-nav-btn { width: 56px; height: 56px; border-radius: 14px; background: linear-gradient(135deg, var(--brand-color) 0%, var(--brand-color-dark) 100%); color: white; border: 2px solid rgba(255, 255, 255, 0.2); cursor: pointer; font-size: 1.5em; box-shadow: 0 12px 32px rgba(124, 58, 237, 0.4); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); user-select: none; }
        .mobile-nav-btn:active { transform: scale(0.95); }
        .mobile-nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        @media (max-width: 768px) {
            .floating-nav { display: none; }
            .page-info { bottom: 20px; padding: 10px 20px; font-size: .85em; }
        }
        @media (min-width: 769px) {
            .mobile-floating-nav { display: none; }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="loading-screen" id="loadingScreen">
            <div class="loading-content">
                <div class="loading-icon">ğŸ“„</div>
                <div class="loading-text loading">PDF ë¡œë”© ì¤‘</div>
                <div class="progress-container">
                    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                    <div class="progress-text" id="progressPercentage">0%</div>
                    <div class="progress-status" id="progressStatus"></div>
                </div>
                <div class="loading-credit">
                    <div class="loading-credit-title">PDF Flipbook</div>
                    <div class="loading-credit-text">
                        ì´ PDF flipbookì€ Perplexity AIë¥¼ í™œìš©í•´<br>
                        <a href="https://welfareact.net" class="loading-credit-link" target="_blank">https://welfareact.net</a>ì—ì„œ ì œì‘í•˜ì˜€ìŠµë‹ˆë‹¤.
                    </div>
                </div>
            </div>
        </div>

        <div class="viewer-screen" id="viewerScreen">
            <div class="top-progress-container" id="topProgressContainer">
                <div class="top-progress-bar" id="topProgressBar"><div class="top-progress-handle" id="topProgressHandle"></div></div>
            </div>
            <div class="floating-nav left"><button class="nav-btn" id="firstBtn" title="ì²˜ìŒìœ¼ë¡œ">â®</button></div>
            <div class="canvas" id="canvas"><div id="flipbook"></div></div>
            <div class="floating-nav right"><button class="nav-btn" id="lastBtn" title="ëìœ¼ë¡œ">â­</button></div>
            <div class="mobile-floating-nav" id="mobileFloatingNav">
                <button class="mobile-nav-btn" id="mobileFirstBtn" title="ì²˜ìŒìœ¼ë¡œ">â®</button>
                <button class="mobile-nav-btn" id="mobileLastBtn" title="ëìœ¼ë¡œ">â­</button>
            </div>
            <div class="touch-zone touch-zone-left" id="touchZoneLeft"></div>
            <div class="touch-zone touch-zone-right" id="touchZoneRight"></div>
            <div class="page-info" id="pageInfo">0/0</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const PDF_URL = 'https://raw.githubusercontent.com/ThornJSH/flip_PDF/main/ì´ìŠˆì™€ ë†€ì ìµœì¢… ë³´ê³ ì„œ.pdf';

        let pdfDoc = null, isMobileDevice = false, pdfOrientation = 'portrait', flipbookReady = false, isDragging = false, menuVisibleTimer = null;

        const loadingScreen = document.getElementById('loadingScreen');
        const viewerScreen = document.getElementById('viewerScreen');

        function detectDevice() { isMobileDevice = /android|webos|iphone|ipad|ipod|blackberry|mobile|opera mini/.test(navigator.userAgent.toLowerCase()); }
        
        function hideLoading() {
            loadingScreen.style.opacity = '0';
            setTimeout(() => { loadingScreen.style.display = 'none'; }, 500);
        }

        function showViewer() { viewerScreen.classList.add('show'); }
        
        function updateProgress(current, total, status = '') {
            const percentage = Math.round((current / total) * 100);
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressPercentage').textContent = percentage + '%';
            if (status) document.getElementById('progressStatus').textContent = status;
        }

        async function loadPDF() {
            try {
                updateProgress(0, 100, 'PDF íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘...');
                const response = await fetch(PDF_URL);
                if (!response.ok) throw new Error('PDF íŒŒì¼ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                
                updateProgress(30, 100, 'PDF ë°ì´í„° ë³€í™˜ ì¤‘...');
                const arrayBuffer = await (await response.blob()).arrayBuffer();
                
                updateProgress(50, 100, 'PDF ë¬¸ì„œ ì´ˆê¸°í™” ì¤‘...');
                pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                updateProgress(60, 100, 'PDF ì •ë³´ ë¶„ì„ ì¤‘...');
                await analyzePDF();
                
                updateProgress(70, 100, 'PDF í˜ì´ì§€ ë Œë”ë§ ì¤‘...');
                await renderFlipbook();
            } catch (error) {
                console.error(error); alert('PDF ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        async function analyzePDF() {
            const numPages = pdfDoc.numPages;
            let landscapeCount = 0;
            for (let i = 1; i <= numPages; i++) {
                const page = await pdfDoc.getPage(i);
                if (page.getViewport({ scale: 1 }).width > page.getViewport({ scale: 1 }).height) landscapeCount++;
            }
            pdfOrientation = landscapeCount > numPages / 2 ? 'landscape' : 'portrait';
        }

        async function renderFlipbook() {
            const flipbook = document.getElementById('flipbook');
            flipbook.innerHTML = '';
            for (let i = 1; i <= pdfDoc.numPages; i++) {
                updateProgress(70 + ((i / pdfDoc.numPages) * 25), 100, `í˜ì´ì§€ ë Œë”ë§: ${i}/${pdfDoc.numPages}`);
                const page = await pdfDoc.getPage(i);
                const vp = page.getViewport({ scale: 2 });
                const canvas = document.createElement('canvas');
                canvas.width = vp.width; canvas.height = vp.height;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;
                const div = document.createElement('div');
                div.className = 'page';
                div.innerHTML = `<img src="${canvas.toDataURL('image/jpeg', 0.9)}" alt="Page ${i}">`;
                flipbook.appendChild(div);
            }
            updateProgress(95, 100, 'Flipbook ì´ˆê¸°í™” ì¤‘...');
            initFlipbook();
        }

        function initFlipbook() {
            showViewer(); 
            const { width, height, display } = getOptimalSize();
            
            $('#flipbook').turn({ 
                width, height, display, 
                autoCenter: true, 
                duration: isMobileDevice ? 500 : 1000, 
                elevation: isMobileDevice ? 20 : 50, 
                gradients: true, 
                when: { turned: (event, page) => updatePage(page) } 
            });

            flipbookReady = true;
            updateProgress(100, 100, 'ì™„ë£Œ!');
            hideLoading();
            
            bindEvents();
            updatePage($('#flipbook').turn('page'));
        }
        
        // *** FIX: Re-calculated for optimal size and guaranteed touch zones ***
        function getOptimalSize() {
            const topBarHeight = document.getElementById('topProgressContainer').offsetHeight;
            const availableWidth = viewerScreen.clientWidth;
            const availableHeight = viewerScreen.clientHeight - topBarHeight;
            
            let width, height, display;

            if (isMobileDevice) {
                // Mobile: Use 100% width for immersive swiping. Touch zones will overlay the content.
                width = availableWidth;
                height = availableHeight;
                display = 'single';
            } else {
                // PC: Use 95% of the screen to leave margins for the touch zones to be clickable.
                width = availableWidth * 0.95;
                height = availableHeight * 0.95;
                display = (pdfOrientation === 'landscape') ? 'single' : 'double';
            }

            return { width, height, display };
        }

        function updatePage(page) {
            if (!flipbookReady) return;
            const total = pdfDoc.numPages;
            document.getElementById('pageInfo').textContent = `${page} / ${total}`;
            document.getElementById('firstBtn').disabled = document.getElementById('mobileFirstBtn').disabled = (page <= 1);
            document.getElementById('lastBtn').disabled = document.getElementById('mobileLastBtn').disabled = (page >= total);
            document.getElementById('topProgressBar').style.width = (page / total) * 100 + '%';
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileFloatingNav');
            menu.classList.add('show');
            clearTimeout(menuVisibleTimer);
            menuVisibleTimer = setTimeout(() => menu.classList.remove('show'), 3000);
        }

        function bindEvents() {
            const canvas = document.getElementById('canvas');
            const progressContainer = document.getElementById('topProgressContainer');
            const handle = document.getElementById('topProgressHandle');
            
            document.getElementById('firstBtn').addEventListener('click', () => $('#flipbook').turn('page', 1));
            document.getElementById('lastBtn').addEventListener('click', () => $('#flipbook').turn('page', pdfDoc.numPages));
            document.getElementById('mobileFirstBtn').addEventListener('click', () => { $('#flipbook').turn('page', 1); document.getElementById('mobileFloatingNav').classList.remove('show'); });
            document.getElementById('mobileLastBtn').addEventListener('click', () => { $('#flipbook').turn('page', pdfDoc.numPages); document.getElementById('mobileFloatingNav').classList.remove('show'); });
            
            document.getElementById('touchZoneLeft').addEventListener('click', () => $('#flipbook').turn('previous'));
            document.getElementById('touchZoneRight').addEventListener('click', () => $('#flipbook').turn('next'));

            let touchStartX = 0;
            canvas.addEventListener('touchstart', (e) => { touchStartX = e.touches[0].clientX; }, { passive: true });
            canvas.addEventListener('touchend', (e) => {
                const diff = touchStartX - e.changedTouches[0].clientX;
                if (diff > 50) $('#flipbook').turn('next');
                else if (diff < -50) $('#flipbook').turn('previous');
            });
            canvas.addEventListener('click', (e) => {
                if (!isMobileDevice) return;
                const rect = canvas.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                if (clickX > rect.width * 0.3 && clickX < rect.width * 0.7) toggleMobileMenu();
            });

            const calculatePage = (x) => {
                const rect = progressContainer.getBoundingClientRect();
                const percentage = Math.max(0, Math.min(x - rect.left, rect.width)) / rect.width;
                return Math.max(1, Math.min(pdfDoc.numPages, Math.ceil(percentage * pdfDoc.numPages)));
            };
            const dragMove = (e) => {
                if (!isDragging) return;
                const clientX = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
                const page = calculatePage(clientX);
                if ($('#flipbook').turn('page') !== page) $('#flipbook').turn('page', page);
            };
            const dragEnd = () => {
                if (!isDragging) return; isDragging = false;
                document.removeEventListener('mousemove', dragMove); document.removeEventListener('mouseup', dragEnd);
                document.removeEventListener('touchmove', dragMove); document.removeEventListener('touchend', dragEnd);
            };
            const dragStart = (e) => {
                isDragging = true; e.preventDefault();
                document.addEventListener('mousemove', dragMove); document.addEventListener('mouseup', dragEnd);
                document.addEventListener('touchmove', dragMove); document.addEventListener('touchend', dragEnd);
            };
            handle.addEventListener('mousedown', dragStart); handle.addEventListener('touchstart', dragStart);
            progressContainer.addEventListener('click', (e) => { if (!isDragging) $('#flipbook').turn('page', calculatePage(e.clientX)); });

            document.addEventListener('keydown', (e) => {
                if (!flipbookReady) return;
                if (e.key === 'ArrowLeft') $('#flipbook').turn('previous');
                else if (e.key === 'ArrowRight') $('#flipbook').turn('next');
                else if (e.key === 'Home') $('#flipbook').turn('page', 1);
                else if (e.key === 'End') $('#flipbook').turn('page', pdfDoc.numPages);
            });

            const debounce = (func, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; };
            const handleResize = () => {
                if (!flipbookReady) return;
                const { width, height, display } = getOptimalSize();
                if ($('#flipbook').turn('display') !== display) {
                    $('#flipbook').turn('destroy');
                    // Re-initialize with a delay to ensure DOM is ready after destroy
                    setTimeout(initFlipbook, 50); 
                } else {
                    $('#flipbook').turn('size', width, height);
                }
            };
            window.addEventListener('resize', debounce(handleResize, 250));
            window.addEventListener('orientationchange', () => setTimeout(handleResize, 100));
        }

        window.addEventListener('DOMContentLoaded', () => {
            detectDevice();
            loadPDF();
        });
    </script>
</body>
</html>