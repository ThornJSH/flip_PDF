<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF 3D Flip Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999;
            color: white;
        }

        #loading-screen.hidden {
            display: none;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 300px;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: white;
            width: 0%;
            transition: width 0.3s;
        }

        .credits {
            font-size: 14px;
            text-align: center;
            margin-top: 20px;
            opacity: 0.9;
        }

        /* Main Container */
        #viewer-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 20px;
        }

        /* Flip Book Container */
        #flipbook-wrapper {
            position: relative;
            width: 90%;
            max-width: 1400px;
            height: 85vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #flipbook {
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }

        #flipbook .page {
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #flipbook .page img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Turn.js 3D Effects */
        .shadow {
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .page-depth {
            position: relative;
        }

        .page-depth::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, rgba(0,0,0,0.1) 0%, transparent 10%);
            pointer-events: none;
        }

        /* Settings Button */
        #settings-btn {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            z-index: 30;
        }

        #settings-btn:hover {
            background: white;
            transform: scale(1.1) rotate(90deg);
        }

        /* Page Info */
        #page-info {
            position: fixed;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 30;
        }

        /* Settings Modal */
        #settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        #settings-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 24px;
            color: #333;
        }

        .close-btn {
            font-size: 30px;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 1;
        }

        .close-btn:hover {
            color: #333;
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-section h3 {
            font-size: 18px;
            color: #555;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-item label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }

        .setting-item input[type="text"],
        .setting-item input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .setting-item input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .radio-group {
            display: flex;
            gap: 15px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .radio-group input[type="radio"] {
            margin-right: 5px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #ddd;
            color: #333;
        }

        .btn-secondary:hover {
            background: #ccc;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .example-text {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            line-height: 1.4;
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            #flipbook-wrapper {
                width: 95%;
                height: 80vh;
            }

            #page-info {
                bottom: 20px;
                font-size: 12px;
                padding: 8px 16px;
            }

            #settings-btn {
                bottom: 20px;
                right: 20px;
                width: 45px;
                height: 45px;
                font-size: 20px;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }

        /* Rotation Classes */
        .rotate-90 {
            transform: rotate(90deg);
        }

        .rotate-180 {
            transform: rotate(180deg);
        }

        .rotate-270 {
            transform: rotate(270deg);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="spinner"></div>
        <div class="loading-text">PDF 로딩 중...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div class="credits">
            <div>Perplexity AI 사용</div>
            <div>welfareact.net에서 제작</div>
        </div>
    </div>

    <!-- Main Viewer -->
    <div id="viewer-container">
        <div id="flipbook-wrapper">
            <div id="flipbook"></div>
        </div>
    </div>

    <!-- Settings Button -->
    <button id="settings-btn">⚙</button>

    <!-- Page Info -->
    <div id="page-info">
        <span id="current-page">1</span> / <span id="total-pages">0</span>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>설정</h2>
                <button class="close-btn" id="close-modal-x">×</button>
            </div>

            <div class="settings-section">
                <h3>보기 설정</h3>
                <div class="setting-item">
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="view-mode" value="double" checked>
                            2쪽 보기
                        </label>
                        <label>
                            <input type="radio" name="view-mode" value="single">
                            1쪽 보기
                        </label>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>화면 회전</h3>
                <div class="setting-item">
                    <div class="checkbox-item">
                        <input type="checkbox" id="rotate-screen">
                        <label for="rotate-screen">90도 회전</label>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>페이지 이동</h3>
                <div class="setting-item">
                    <label>페이지 번호:</label>
                    <input type="number" id="goto-page" min="1" placeholder="페이지 번호 입력">
                </div>
            </div>

            <div class="settings-section">
                <h3>PDF 불러오기</h3>
                <div class="setting-item">
                    <label>PDF URL:</label>
                    <input type="text" id="pdf-url" placeholder="https://example.com/document.pdf">
                    <div class="example-text">
                        GitHub: https://raw.githubusercontent.com/[user]/[repo]/main/document.pdf<br>
                        Google Drive: https://drive.google.com/uc?export=download&amp;id=[FILE_ID]
                    </div>
                </div>
                <div class="setting-item" style="margin-top: 15px;">
                    <label>파일 업로드:</label>
                    <input type="file" id="pdf-file" accept=".pdf">
                </div>
                <div class="setting-item" style="margin-top: 15px;">
                    <button class="btn btn-secondary" id="load-default-btn">기본 PDF 사용 (flip.pdf)</button>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-btn">취소</button>
                <button class="btn btn-primary" id="save-btn">저장</button>
            </div>
        </div>
    </div>

    <!-- jQuery (required for Turn.js) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Turn.js Library -->
    <script src="https://cdn.jsdelivr.net/gh/blasten/turn.js@master/turn.min.js"></script>
    
    <!-- PDF.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist/build/pdf.min.js"></script>

    <script>
        // PDF.js worker configuration
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist/build/pdf.worker.min.js';
        }

        // Application State
        const state = {
            pdfDoc: null,
            currentPage: 1,
            totalPages: 0,
            viewMode: 'double',
            rotationAngle: 0,
            renderedPages: {},
            isMobile: window.innerWidth <= 768,
            currentPdfSource: './flip.pdf',
            pendingSettings: {}
        };

        // DOM Elements
        const elements = {
            loadingScreen: document.getElementById('loading-screen'),
            progressFill: document.getElementById('progress-fill'),
            flipbook: $('#flipbook'),
            settingsBtn: document.getElementById('settings-btn'),
            currentPageSpan: document.getElementById('current-page'),
            totalPagesSpan: document.getElementById('total-pages'),
            settingsModal: document.getElementById('settings-modal'),
            closeModalX: document.getElementById('close-modal-x'),
            viewModeRadios: document.querySelectorAll('input[name="view-mode"]'),
            rotateCheckbox: document.getElementById('rotate-screen'),
            gotoPageInput: document.getElementById('goto-page'),
            pdfUrlInput: document.getElementById('pdf-url'),
            pdfFileInput: document.getElementById('pdf-file'),
            loadDefaultBtn: document.getElementById('load-default-btn'),
            saveBtn: document.getElementById('save-btn'),
            cancelBtn: document.getElementById('cancel-btn'),
            flipbookWrapper: document.getElementById('flipbook-wrapper')
        };

        // Initialize Application
        async function init() {
            await loadPDF('./flip.pdf');
            setupEventListeners();
        }

        // Load PDF
        async function loadPDF(source) {
            try {
                elements.loadingScreen.classList.remove('hidden');
                elements.progressFill.style.width = '0%';

                let loadingTask;
                if (typeof source === 'string') {
                    loadingTask = pdfjsLib.getDocument(source);
                } else {
                    loadingTask = pdfjsLib.getDocument({data: source});
                }

                loadingTask.onProgress = function(progress) {
                    if (progress.total > 0) {
                        const percent = (progress.loaded / progress.total) * 100;
                        elements.progressFill.style.width = percent + '%';
                    }
                };

                state.pdfDoc = await loadingTask.promise;
                state.totalPages = state.pdfDoc.numPages;
                state.currentPage = 1;
                state.renderedPages = {};
                state.currentPdfSource = source;

                elements.totalPagesSpan.textContent = state.totalPages;
                elements.gotoPageInput.max = state.totalPages;

                await initFlipbook();

                setTimeout(() => {
                    elements.loadingScreen.classList.add('hidden');
                }, 500);
            } catch (error) {
                console.error('PDF 로딩 오류:', error);
                alert('PDF를 로드할 수 없습니다. 파일 경로를 확인해주세요.');
                elements.loadingScreen.classList.add('hidden');
            }
        }

        // Initialize Turn.js Flipbook
        async function initFlipbook() {
            // Destroy existing flipbook if any
            if (elements.flipbook.turn('is')) {
                elements.flipbook.turn('destroy');
            }

            // Clear flipbook
            elements.flipbook.html('');

            // Add pages
            for (let i = 1; i <= state.totalPages; i++) {
                elements.flipbook.append(`<div class="page" id="page-${i}"></div>`);
            }

            // Calculate dimensions
            const wrapperWidth = elements.flipbookWrapper.offsetWidth;
            const wrapperHeight = elements.flipbookWrapper.offsetHeight;
            let width, height;

            if (state.viewMode === 'double' && !state.isMobile) {
                width = wrapperWidth * 0.9;
                height = wrapperHeight * 0.9;
            } else {
                width = wrapperWidth * 0.7;
                height = wrapperHeight * 0.9;
            }

            // Initialize Turn.js with 3D effects
            elements.flipbook.turn({
                width: width,
                height: height,
                autoCenter: true,
                display: state.viewMode === 'double' && !state.isMobile ? 'double' : 'single',
                acceleration: true,
                gradients: true,
                elevation: 75,
                when: {
                    turning: function(event, page, view) {
                        state.currentPage = page;
                        updatePageInfo();
                    },
                    turned: function(event, page, view) {
                        state.currentPage = page;
                        updatePageInfo();
                        // Render visible pages
                        renderVisiblePages();
                    }
                }
            });

            // Render initial pages
            await renderVisiblePages();
        }

        // Render Visible Pages
        async function renderVisiblePages() {
            const currentView = elements.flipbook.turn('view');
            
            for (let pageNum of currentView) {
                if (pageNum > 0 && pageNum <= state.totalPages) {
                    await renderPage(pageNum);
                }
            }

            // Preload adjacent pages
            const nextPages = elements.flipbook.turn('view');
            for (let pageNum of nextPages) {
                if (pageNum + 1 <= state.totalPages) {
                    renderPage(pageNum + 1);
                }
                if (pageNum - 1 > 0) {
                    renderPage(pageNum - 1);
                }
            }
        }

        // Render Single Page
        async function renderPage(pageNum) {
            if (pageNum < 1 || pageNum > state.totalPages) return;
            if (state.renderedPages[pageNum]) {
                // Already rendered
                const pageElement = $(`#page-${pageNum}`);
                if (pageElement.find('img').length === 0) {
                    pageElement.html(`<img src="${state.renderedPages[pageNum]}" alt="Page ${pageNum}">`);
                }
                return;
            }

            try {
                const page = await state.pdfDoc.getPage(pageNum);
                const scale = 2.0;
                const viewport = page.getViewport({ scale });

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;

                const dataUrl = canvas.toDataURL();
                state.renderedPages[pageNum] = dataUrl;

                const pageElement = $(`#page-${pageNum}`);
                pageElement.html(`<img src="${dataUrl}" alt="Page ${pageNum}">`);
                pageElement.addClass('shadow page-depth');
            } catch (error) {
                console.error(`페이지 ${pageNum} 렌더링 오류:`, error);
            }
        }

        // Update Page Info
        function updatePageInfo() {
            elements.currentPageSpan.textContent = state.currentPage;
        }

        // Apply Settings
        async function applySettings() {
            const settings = state.pendingSettings;
            let needsReload = false;
            let pdfSource = null;

            // Check view mode
            if (settings.viewMode && settings.viewMode !== state.viewMode) {
                state.viewMode = settings.viewMode;
                needsReload = true;
            }

            // Apply rotation
            if (settings.rotation !== undefined) {
                if (settings.rotation) {
                    state.rotationAngle = (state.rotationAngle + 90) % 360;
                } else {
                    state.rotationAngle = 0;
                }
                elements.flipbookWrapper.style.transform = `rotate(${state.rotationAngle}deg)`;
            }

            // Check PDF source
            if (settings.pdfUrl) {
                pdfSource = settings.pdfUrl;
            } else if (settings.pdfFile) {
                pdfSource = settings.pdfFile;
            } else if (settings.useDefault) {
                pdfSource = './flip.pdf';
            }

            // Load new PDF if specified
            if (pdfSource && pdfSource !== state.currentPdfSource) {
                await loadPDF(pdfSource);
            } else if (needsReload) {
                await initFlipbook();
            }

            // Go to page
            if (settings.gotoPage && settings.gotoPage !== state.currentPage) {
                elements.flipbook.turn('page', settings.gotoPage);
            }

            // Clear pending settings
            state.pendingSettings = {};
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Settings button
            elements.settingsBtn.addEventListener('click', () => {
                // Reset form to current state
                document.querySelector(`input[name="view-mode"][value="${state.viewMode}"]`).checked = true;
                elements.rotateCheckbox.checked = false;
                elements.gotoPageInput.value = '';
                elements.pdfUrlInput.value = '';
                elements.pdfFileInput.value = '';
                
                elements.settingsModal.classList.add('active');
            });

            // Close modal (X button)
            elements.closeModalX.addEventListener('click', () => {
                elements.settingsModal.classList.remove('active');
            });

            // Cancel button
            elements.cancelBtn.addEventListener('click', () => {
                state.pendingSettings = {};
                elements.settingsModal.classList.remove('active');
            });

            // Save button
            elements.saveBtn.addEventListener('click', async () => {
                // Collect settings
                state.pendingSettings = {};

                // View mode
                const selectedViewMode = document.querySelector('input[name="view-mode"]:checked').value;
                state.pendingSettings.viewMode = selectedViewMode;

                // Rotation
                state.pendingSettings.rotation = elements.rotateCheckbox.checked;

                // Page navigation
                const gotoPage = parseInt(elements.gotoPageInput.value);
                if (gotoPage >= 1 && gotoPage <= state.totalPages) {
                    state.pendingSettings.gotoPage = gotoPage;
                }

                // PDF source
                const pdfUrl = elements.pdfUrlInput.value.trim();
                if (pdfUrl) {
                    state.pendingSettings.pdfUrl = pdfUrl;
                } else if (elements.pdfFileInput.files.length > 0) {
                    const file = elements.pdfFileInput.files[0];
                    if (file.type === 'application/pdf') {
                        const reader = new FileReader();
                        await new Promise((resolve) => {
                            reader.onload = function(event) {
                                state.pendingSettings.pdfFile = new Uint8Array(event.target.result);
                                resolve();
                            };
                            reader.readAsArrayBuffer(file);
                        });
                    }
                }

                // Close modal
                elements.settingsModal.classList.remove('active');

                // Apply settings
                await applySettings();
                
                // Show confirmation
                alert('설정이 적용되었습니다.');
            });

            // Load default PDF button
            elements.loadDefaultBtn.addEventListener('click', () => {
                elements.pdfUrlInput.value = '';
                elements.pdfFileInput.value = '';
                state.pendingSettings.useDefault = true;
            });

            // Click outside modal to close
            elements.settingsModal.addEventListener('click', (e) => {
                if (e.target === elements.settingsModal) {
                    state.pendingSettings = {};
                    elements.settingsModal.classList.remove('active');
                }
            });

            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (elements.settingsModal.classList.contains('active')) return;
                
                if (e.key === 'ArrowLeft') {
                    elements.flipbook.turn('previous');
                } else if (e.key === 'ArrowRight') {
                    elements.flipbook.turn('next');
                }
            });

            // Window resize
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(async () => {
                    const wasMobile = state.isMobile;
                    state.isMobile = window.innerWidth <= 768;
                    if (wasMobile !== state.isMobile) {
                        await initFlipbook();
                    }
                }, 300);
            });
        }

        // Start the application
        $(document).ready(function() {
            init();
        });
    </script>
</body>
</html>